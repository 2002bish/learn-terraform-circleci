version: 2.1
orbs: 
  terraform: circleci/terraform@3.0.1
workflows:
  deploy_infrastructure:
    jobs:
      - terraform/fmt:
          checkout: true
          context: tfc-dev-rita
					tag: 1.2.0-beta1
      - terraform/validate:
          checkout: true
          context: tfc-dev-rita
					tag: 1.2.0-beta1
          requires:
            - terraform/fmt
      # - terraform/plan:
      #     checkout: true
      #     context: terraform
      #     persist-workspace: true
      #     requires:
      #       - terraform/validate
      # - terraform/apply:
      #     attach-workspace: true
      #     context: terraform
      #     filters:
      #       branches:
      #         only: master
      #     requires:
      #       - terraform/plan



# jobs:
#   single-job-lifecycle:
#     executor: terraform/default
#     steps:
#       - checkout
#       - terraform/init:
#           path: .
#       - terraform/validate:
#           path: .
#       - terraform/fmt:
#           path: .
#       - terraform/plan:
#           path: .
#       - terraform/apply:
#           path: .
#       - terraform/destroy:
#           path: .
#     working_directory: ~/src
# workflows:
#   single-job-lifecycle:
#     jobs:
#       - single-job-lifecycle






# jobs:
#   plan-apply:
#     working_directory: /tmp/project
#     docker:
#       - image: docker.mirror.hashicorp.services/hashicorp/terraform:light
#     steps:
#       - checkout
#       - run:
#           name: terraform init & plan
#           command: |
#             terraform init -input=false
#             terraform plan -out tfapply -var-file variables.tfvars
#       - persist_to_workspace:
#           root: .
#           paths:
#             - .
#
#   apply:
#     docker:
#       - image: docker.mirror.hashicorp.services/hashicorp/terraform:light
#     steps:
#       - attach_workspace:
#           at: .
#       - run:
#           name: terraform
#           command: |
#             terraform apply -auto-approve tfapply
#       - persist_to_workspace:
#           root: .
#           paths:
#             - .
#
#   plan-destroy:
#     docker:
#       - image: docker.mirror.hashicorp.services/hashicorp/terraform:light
#     steps:
#       - attach_workspace:
#           at: .
#       - run:
#           name: terraform create destroy plan
#           command: |
#             terraform plan -destroy -out tfdestroy -var-file variables.tfvars
#       - persist_to_workspace:
#           root: .
#           paths:
#             - .
#
#   destroy:
#     docker:
#       - image: docker.mirror.hashicorp.services/hashicorp/terraform:light
#     steps:
#       - attach_workspace:
#           at: .
#       - run:
#           name: terraform destroy
#           command: |
#             terraform apply -auto-approve tfdestroy
#
# workflows:
#   version: 2
#   plan_approve_apply:
#     jobs:
#       - plan-apply
#       - hold-apply:
#           type: approval
#           requires:
#             - plan-apply
#       - apply:
#           requires:
#             - hold-apply
#       - plan-destroy:
#           requires:
#             - apply
#       - hold-destroy:
#           type: approval
#           requires:
#             - plan-destroy
#       - destroy:
#           requires:
#             - hold-destroy
